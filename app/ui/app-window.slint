import {
    Button,
    VerticalBox,
    HorizontalBox,
    GridBox,
    ScrollView,
} from "std-widgets.slint";

export struct NodeStatus {
    running: bool,
    okay: bool,
}


export enum DeviceRelationship{ paired, connected, found }

export struct Device {
    name: string,
    color: color,
    address: string,
    port: int,
    id: string,
    relationship: DeviceRelationship,
}

component RelationshipBadge inherits Rectangle {
    in property <DeviceRelationship> relationship;

    property <string> label: relationship == DeviceRelationship.paired ? "Paired" : relationship == DeviceRelationship.connected ? "Connected" : "Found";
    property <color> badge_color: relationship == DeviceRelationship.paired ? #3b82f6 : relationship == DeviceRelationship.connected ? #22c55e : #f59e0b;

    background: badge_color;
    min-width: 80px;
    height: 24px;

    VerticalLayout {
        padding: 4px;

        Text {
            text: root.label;
            font-size: 11px;
            font-weight: 600;
            color: white;
            horizontal-alignment: center;
            vertical-alignment: center;
        }
    }
}

component DeviceCard inherits Rectangle {
    in property <Device> device;

    background: #1f1f1f;
    border-width: 1px;
    border-color: #333333;

    property <length> card_spacing: 8px;

    VerticalLayout {
        spacing: card_spacing;
        padding: 12px;

        // Header: Color indicator + Name + Relationship badge
        HorizontalLayout {
            spacing: card_spacing;

            // Color indicator square
            Rectangle {
                background: device.color;
                width: 24px;
                height: 24px;
            }

            // Device name
            Text {
                text: device.name;
                font-size: 16px;
                font-weight: 600;
                color: #ffffff;
                vertical-alignment: center;
                horizontal-alignment: left;
            }

            Rectangle {
                background: transparent;
                horizontal-stretch: 1;
            }

            // Relationship badge
            RelationshipBadge {
                relationship: device.relationship;
            }
        }

        // Connection info (address:port)
        HorizontalLayout {
            spacing: card_spacing;
            visible: device.relationship != DeviceRelationship.paired;

            Image {
                source: @image-url("icons/location.svg");
                width: 16px;
                height: 16px;
            }

            Text {
                text: device.address + ":" + device.port;
                font-size: 13px;
                color: #888888;
                vertical-alignment: center;
            }
        }

        // Device ID
        HorizontalLayout {
            spacing: card_spacing;

            Image {
                source: @image-url("icons/id.svg");
                width: 16px;
                height: 16px;
            }

            Text {
                text: "ID: " + device.id;
                font-size: 13px;
                color: #888888;
                vertical-alignment: center;
            }
        }
    }
}

component Devices {
    in property <[Device]> devices;

    VerticalLayout {
        spacing: 8px;
        padding: 10px;

        for device in devices: DeviceCard {
            device: device;
            height: 100px;
        }
    }
}

component NodeToggleButton inherits Rectangle {
    in property <NodeStatus> node_status;
    callback run_node(bool);

    property <bool> is_running: node_status.running && node_status.okay;

    background: #2d2d2d;
    height: 60px;

    HorizontalLayout {
        spacing: 0px;

        // Status indicator bar
        Rectangle {
            width: 5px;
            background: root.is_running ? #4cc2ff : #666666;
        }

        // Button content
        HorizontalLayout {
            spacing: 14px;
            padding: 16px;
            horizontal-stretch: 1;

            // Icon
            Rectangle {
                background: root.is_running ? #4cc2ff : #666666;
                width: 28px;
                height: 28px;

                Rectangle {
                    width: 12px;
                    height: 12px;
                    background: #1a1a1a;
                    x: 8px;
                    y: 8px;
                }
            }

            // Label
            Text {
                text: root.is_running ? "Node Running" : "Node Stopped";
                font-size: 16px;
                font-weight: 600;
                color: #ffffff;
                vertical-alignment: center;
            }

            Rectangle {
                background: transparent;
                horizontal-stretch: 1;
            }

            // Toggle switch
            Rectangle {
                background: root.is_running ? #4cc2ff : #444444;
                width: 52px;
                height: 28px;

                Rectangle {
                    width: 20px;
                    height: 20px;
                    background: #1a1a1a;
                    x: root.is_running ? 28px : 4px;
                    y: 4px;

                    animate x {
                        duration: 150ms;
                        easing: ease-in-out;
                    }
                }
            }
        }
    }

    TouchArea {
        clicked => {
            root.run_node(!root.is_running);
        }
    }
}

component StatusPage {
    callback run_node(bool);
    in property <NodeStatus> node_status;
    in property <[Device]> devices;

    VerticalLayout {
        spacing: 0px;

        // Header bar
        Rectangle {
            background: #202020;
            height: 60px;

            HorizontalLayout {
                spacing: 16px;
                padding: 20px;

                Text {
                    text: "Device Manager";
                    font-size: 20px;
                    font-weight: 600;
                    color: #ffffff;
                    vertical-alignment: center;
                }

                Rectangle {
                    background: transparent;
                    horizontal-stretch: 1;
                }

                // Status indicator
                Rectangle {
                    background: node_status.okay ? #1a5c3a : #8b3a1a;
                    height: 36px;

                    HorizontalLayout {
                        padding: 8px;
                        spacing: 8px;

                        Rectangle {
                            width: 10px;
                            height: 10px;
                            background: node_status.okay ? #4ade80 : #f87171;
                            y: 2px;
                        }

                        Text {
                            text: node_status.okay ? "System OK" : "System Error";
                            font-size: 14px;
                            font-weight: 600;
                            color: white;
                            vertical-alignment: center;
                        }
                    }
                }
            }
        }

        // Node control button
        NodeToggleButton {
            node_status: node_status;
            run_node(val) => root.run_node(val);
        }

        // Devices section header
        Rectangle {
            background: #202020;
            height: 44px;

            HorizontalLayout {
                padding: 16px;
                spacing: 12px;

                Text {
                    text: "Devices";
                    font-size: 14px;
                    font-weight: 600;
                    color: #888888;
                    vertical-alignment: center;
                }

                Rectangle {
                    background: #333333;
                    width: 2px;
                }

                Text {
                    text: devices.length + "";
                    font-size: 13px;
                    color: #666666;
                    vertical-alignment: center;
                }
            }
        }

        // Device list container
        Rectangle {
            background: #1a1a1a;
            vertical-stretch: 1;

            Devices {
                devices: devices;
                width: parent.width;
                height: parent.height;
            }
        }
    }
}

export component MainWindow inherits Window {
    in property <NodeStatus> node_status;
    in property <[Device]> devices;

    preferred-height: 750px;
    preferred-width: 500px;
    background: #1a1a1a;

    StatusPage {
        node_status: node_status;
        devices: devices;
    }
}
