import {
    Button,
    VerticalBox,
    HorizontalBox,
    GridBox,
} from "std-widgets.slint";

export struct NodeStatus {
    running: bool,
    okay: bool,
}


export enum DeviceRelationship{ paired, connected, found }

export struct Device {
    name: string,
    color: color,
    address: string,
    port: int,
    id: string,
    relationship: DeviceRelationship,
}

component RelationshipBadge inherits Rectangle {
    in property <DeviceRelationship> relationship;

    property <string> label: relationship == DeviceRelationship.paired ? "Paired" : relationship == DeviceRelationship.connected ? "Connected" : "Found";
    property <color> badge_color: relationship == DeviceRelationship.paired ? #3b82f6 : relationship == DeviceRelationship.connected ? #22c55e : #f59e0b;

    background: badge_color;
    border-radius: 4px;
    min-width: 70px;

    VerticalLayout {
        padding: 4px;

        Text {
            text: root.label;
            font-size: 10px;
            font-weight: 600;
            color: white;
            horizontal-alignment: center;
            vertical-alignment: center;
        }
    }
}

component DeviceCard inherits Rectangle {
    in property <Device> device;

    border-radius: 12px;
    background: #1a1a2e;

    property <length> card_spacing: 8px;

    VerticalLayout {
        spacing: card_spacing;
        padding: 12px;

        // Header: Color indicator + Name + Relationship badge
        HorizontalLayout {
            spacing: card_spacing;

            // Color indicator circle
            Rectangle {
                background: device.color;
                border-radius: self.height / 2;
                width: 24px;
                height: 24px;
            }

            // Device name
            Text {
                text: device.name;
                font-size: 16px;
                font-weight: 600;
                color: #e0e0e0;
                vertical-alignment: center;
                horizontal-alignment: left;
            }

            Rectangle {
                background: transparent;
                horizontal-stretch: 1;
            }

            // Relationship badge
            RelationshipBadge {
                relationship: device.relationship;
            }
        }

        // Connection info (address:port)
        HorizontalLayout {
            spacing: card_spacing;
            visible: device.relationship != DeviceRelationship.paired;

            Image {
                source: @image-url("icons/location.svg");
                width: 16px;
                height: 16px;
            }

            Text {
                text: device.address + ":" + device.port;
                font-size: 12px;
                color: #888888;
                vertical-alignment: center;
            }
        }

        // Device ID
        HorizontalLayout {
            spacing: card_spacing;

            Image {
                source: @image-url("icons/id.svg");
                width: 16px;
                height: 16px;
            }

            Text {
                text: "ID: " + device.id;
                font-size: 12px;
                color: #888888;
                vertical-alignment: center;
            }
        }
    }
}

component Devices {
    in property <[Device]> devices;

    VerticalLayout {
        spacing: 10px;
        padding: 10px;

        for device in devices: DeviceCard {
            device: device;
            height: 100px;
        }
    }
}

component NodeButton inherits Rectangle {
    in property <NodeStatus> node_status;
    callback run_node(bool);

    property <bool> query_running: node_status.running;

    property <int> padd:  5;
    // function & pure function

    background: node_status.okay ? gray : yellowgreen;
    border-radius: self.height / 2;

    button_knob := Rectangle {
        height: root.height - padd * 2px;
        width: self.height;
        border-radius: self.height / 2;
        x: query_running ? padd * 1px : root.width - padd * 1px - self.width;
        animate x, background {
            easing: ease-in;
            duration: 100ms;
        }
        y: padd * 1px;
        background: node_status.running ? green : darkgray;

        Rectangle {
            property <int> ipad: 10;
            width: button_knob.width - ipad * 2px;
            height: self.width;
            border-radius: self.width / 2;
            y: ipad * 1px;
            x: ipad * 1px;
            background: button_knob.background.brighter(0.1);
        }
    }

    TouchArea {
        clicked => {
            query_running = !query_running;
            run_node(query_running);
        }
    }
}

component StatusPage {
    callback run_node(bool);
    in property <NodeStatus> node_status;
    in property <[Device]> devices;

    VerticalLayout {
        spacing: 15px;
        padding: 15px;

        // Header with title and status
        HorizontalLayout {
            spacing: 10px;

            Text {
                text: "Device Manager";
                font-size: 20px;
                font-weight: 600;
                color: #e0e0e0;
                vertical-alignment: center;
            }

            Rectangle {
                background: transparent;
                horizontal-stretch: 1;
            }

            // Status indicator
            Rectangle {
                background: node_status.okay ? #22c55e : #ef4444;
                border-radius: 4px;

                VerticalLayout {
                    padding: 6px;

                    Text {
                        text: node_status.okay ? "OK" : "Error";
                        font-size: 11px;
                        font-weight: 600;
                        color: white;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }
                }
            }
        }

        // Node control button
        NodeButton {
            node_status: node_status;
            width: 180px;
            height: 90px;
            run_node(val) => root.run_node(val);
        }

        // Devices section header
        HorizontalLayout {
            spacing: 8px;

            Text {
                text: "Devices";
                font-size: 14px;
                font-weight: 600;
                color: #a0a0a0;
                vertical-alignment: center;
            }

            Rectangle {
                background: #333350;
                height: 1px;
                horizontal-stretch: 1;
            }

            Text {
                text: devices.length + "";
                font-size: 12px;
                color: #666680;
                vertical-alignment: center;
            }
        }

        // Device list container
        Rectangle {
            background: #0f0f1a;
            border-radius: 8px;
            vertical-stretch: 1;
            clip: true;

            Devices {
                devices: devices;
                width: parent.width;
                height: parent.height;
            }
        }
    }
}

export component MainWindow inherits Window {
    in property <NodeStatus> node_status;
    in property <[Device]> devices;

    preferred-height: 600px;
    preferred-width: 400px;
    background: #121218;

    StatusPage {
        node_status: node_status;
        devices: devices;
    }
}
